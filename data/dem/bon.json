{
  "DEM": {
    ".": "/bon/base",
    "calc": {
      "type": {
        ".": {
          "desc": "Codifier for calculation types.",
          "attr": {
            "id": {
              "type": "identity",
              "desc": "Calculation type ID."
            },
            "code": {
              "type": "string",
              "desc": "Calculation code to be referenced from programs/scripts."
            },
            "note": {
              "type": "string",
              "desc": "Calculation type reference for humans."
            }
          },
          "index": {
            "uniqueCode": {
              "type": "unique",
              "attrs": ["code"]
            }
          }
        }
      }
    },
    "plan": {
      ".": {
        "desc": "Set of calculations related to one period.",
        "attr": {
          "id": {
            "type": "identity",
            "desc": "Plan ID."
          },
          "period": {
            "type": "integer",
            "desc": "Calculation period: 1 - day, 2 - week, 3 - month, 4 - year.",
            "small": true,
            "unsigned": true
          },
          "note": {
            "type": "string",
            "desc": "Plan description for humans."
          }
        }
      },
      "calc": {
        ".": {
          "desc": "Calculations are bound to the concrete plan.",
          "attr": {
            "calc_id": {
              "type": "identity",
              "desc": "Calculation ID."
            },
            "plan_ref": {
              "type": "reference",
              "desc": "Reference to the plan."
            },
            "type_ref": {
              "type": "reference",
              "desc": "Reference to the calculation type."
            },
            "sequence": {
              "type": "integer",
              "desc": "Calculation sequence (order) in the plan.",
              "small": true,
              "unsigned": true
            },
            "date_started": {
              "type": "datetime",
              "desc": "Date when first calculation was (will be) performed.",
              "small": true,
              "unsigned": true
            }
          },
          "relation": {
            "plan": {
              "path": "/bon/base/plan",
              "own": ["plan_ref"],
              "foreign": ["id"],
              "on": {"delete": "restrict", "update": "cascade"}
            },
            "calcType": {
              "path": "/bon/base/calc/type",
              "own": ["type_ref"],
              "foreign": ["id"],
              "on": {"delete": "restrict", "update": "cascade"}
            }
          }
        }
      },
      "rank": {
        ".": {
          "desc": "Ranks are bound to the concrete plan.",
          "attr": {
            "rank_id": {
              "type": "identity",
              "desc": "Rank ID."
            },
            "plan_ref": {
              "type": "reference",
              "desc": "Reference to the plan."
            },
            "code": {
              "type": "string",
              "desc": "Small code for the rank."
            },
            "note": {
              "type": "string",
              "desc": "Description of the rank for humans."
            },
            "sequence": {
              "type": "integer",
              "desc": "Calculation sequence (order) in the plan.",
              "small": true,
              "unsigned": true
            }
          },
          "relation": {
            "plan": {
              "path": "/bon/base/plan",
              "own": ["plan_ref"],
              "foreign": ["id"],
              "on": {"delete": "restrict", "update": "cascade"}
            }
          }
        }
      }
    },
    "qual": {
      "rule": {
        ".": {
          "desc": "Registry for qualification rules.",
          "attr": {
            "id": {
              "type": "identity",
              "desc": "Qualification rule ID."
            },
            "type": {
              "type": "string",
              "desc": "Qualification rule type (codified)."
            }
          }
        },
        "group": {
          ".": {
            "desc": "Grouping rule details.",
            "attr": {
              "ref": {
                "type": "reference",
                "desc": "Reference to the grouping rule (type: GROUP)."
              },
              "logic": {
                "type": "string",
                "desc": "Grouping logic (and, or, not).",
                "size": 3
              }
            },
            "index": {
              "pk": {
                "type": "primary",
                "attrs": ["ref"]
              }
            },
            "relation": {
              "rule": {
                "path": "/bon/base/qual/rule",
                "own": ["ref"],
                "foreign": ["id"],
                "on": {"delete": "cascade", "update": "cascade"}
              }
            }
          },
          "ref": {
            ".": {
              "desc": "Grouped rules.",
              "attr": {
                "grouping_ref": {
                  "type": "reference",
                  "desc": "Reference to the grouping rule."
                },
                "grouped_ref": {
                  "type": "reference",
                  "desc": "References to the rules are been grouped."
                }
              },
              "index": {
                "pk": {
                  "type": "primary",
                  "attrs": ["grouping_ref", "grouped_ref"]
                }
              },
              "relation": {
                "groupingRule": {
                  "path": "/bon/base/qual/rule/group",
                  "own": ["grouping_ref"],
                  "foreign": ["ref"],
                  "on": {"delete": "cascade", "update": "cascade"}
                },
                "groupedRule": {
                  "path": "/bon/base/qual/rule",
                  "own": ["grouped_ref"],
                  "foreign": ["id"],
                  "on": {"delete": "cascade", "update": "cascade"}
                }
              }
            }
          }
        },
        "pv": {
          ".": {
            "desc": "PV rules details.",
            "attr": {
              "ref": {
                "type": "reference",
                "desc": "Reference to the PV rule (type: PV)."
              },
              "volume": {
                "type": "decimal",
                "desc": "Minimal qualification volume.",
                "precision": 10,
                "scale": 2
              },
              "autoship_only": {
                "type": "boolean",
                "default": false,
                "desc": "'true' if Autoship PV only is applied to qualification."
              },
              "period": {
                "type": "integer",
                "desc": "0 - PV from current period is applied; 1 - one period ago PV is applied; 2 - two periods ago ...",
                "default": 0,
                "small": true,
                "unsigned": true
              }
            },
            "index": {
              "pk": {
                "type": "primary",
                "attrs": ["ref"]
              }
            },
            "relation": {
              "rule": {
                "path": "/bon/base/qual/rule",
                "own": ["ref"],
                "foreign": ["id"],
                "on": {"delete": "cascade", "update": "cascade"}
              }
            }
          }
        }
      }
    },
    "reg": {
      "cv": {
        ".": {
          "desc": "Registry to save (Autoship) Commissionable Volumes (CV/ACV) movements.",
          "attr": {
            "id": {
              "type": "identity",
              "desc": "Registry entry ID."
            },
            "client_ref": {
              "type": "reference",
              "desc": "Reference to the client."
            },
            "volume": {
              "type": "decimal",
              "desc": "Amount of the CV/ACV to be add/subtract to/from client.",
              "precision": 10,
              "scale": 2
            },
            "is_autoship": {
              "type": "boolean",
              "default": false,
              "desc": "'true' if this is an Autoship CV."
            },
            "date": {
              "type": "datetime",
              "desc": "Timestamp to apply CV movement for client (used in bonus calculations)."
            },
            "note": {
              "type": "string",
              "desc": "Movement reference for humans (sale #... or smth. like this).",
              "nullable": true
            }
          },
          "relation": {
            "member": {
              "path": "/client/reg",
              "own": ["client_ref"],
              "foreign": ["client_ref"],
              "on": {"delete": "restrict", "update": "cascade"}
            }
          }
        }
      }
    }
  }
}