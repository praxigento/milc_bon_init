{
  "DEM": {
    ".": "/bon",
    "calc": {
      ".note": "Configuration for various types of calculations.",
      "comm": {
        "level": {
          ".": {
            "desc": "Configuration for level based commission calculations.",
            "attr": {
              "calc_ref": {
                "type": "reference",
                "desc": "Reference to the calculation."
              },
              "rank_ref": {
                "type": "reference",
                "desc": "Reference to the rank."
              },
              "level": {
                "type": "integer",
                "unsigned": true,
                "small": true,
                "desc": "Level in downline tree (1, 2, ...)."
              },
              "percent": {
                "type": "decimal",
                "desc": "Commission percent from the level for the rank.",
                "precision": 5,
                "scale": 4
              }
            },
            "index": {
              "pk": {
                "type": "primary",
                "attrs": ["calc_ref", "rank_ref", "level"]
              }
            },
            "relation": {
              "calc": {
                "path": "/bon/plan/suite/calc",
                "own": ["calc_ref"],
                "foreign": ["id"],
                "on": {"delete": "cascade", "update": "cascade"}
              },
              "rank": {
                "path": "/bon/plan/rank",
                "own": ["rank_ref"],
                "foreign": ["id"],
                "on": {"delete": "cascade", "update": "cascade"}
              }
            }
          }
        }
      },
      "rank": {
        ".": {
          "desc": "Relations between ranks and qualification rules.",
          "attr": {
            "calc_ref": {
              "type": "reference",
              "desc": "Reference to the calculation."
            },
            "rank_ref": {
              "type": "reference",
              "desc": "Reference to the rank."
            },
            "rule_ref": {
              "type": "reference",
              "desc": "Reference to the qualification rule."
            }
          },
          "index": {
            "pk": {
              "type": "primary",
              "attrs": ["calc_ref", "rank_ref", "rule_ref"]
            }
          },
          "relation": {
            "calc": {
              "path": "/bon/plan/suite/calc",
              "own": ["calc_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            },
            "rank": {
              "path": "/bon/plan/rank",
              "own": ["rank_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            },
            "rule": {
              "path": "/bon/calc/rank/rule",
              "own": ["rule_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            }
          }
        },
        "rule": {
          ".": {
            "desc": "Qualification rules registry.",
            "attr": {
              "id": {
                "type": "identity",
                "desc": "Qualification rule ID."
              },
              "type": {
                "type": "string",
                "desc": "Qualification rule type (codified)."
              }
            }
          },
          "group": {
            ".": {
              "desc": "Grouping rule details.",
              "attr": {
                "ref": {
                  "type": "reference",
                  "desc": "Reference to the grouping rule (type: group)."
                },
                "logic": {
                  "type": "string",
                  "desc": "Grouping logic (and, or, not).",
                  "size": 3
                }
              },
              "index": {
                "pk": {
                  "type": "primary",
                  "attrs": ["ref"]
                }
              },
              "relation": {
                "rule": {
                  "path": "/bon/calc/rank/rule",
                  "own": ["ref"],
                  "foreign": ["id"],
                  "on": {"delete": "cascade", "update": "cascade"}
                }
              }
            },
            "ref": {
              ".": {
                "desc": "Grouped rules in grouping rules.",
                "attr": {
                  "grouping_ref": {
                    "type": "reference",
                    "desc": "Reference to the grouping rule."
                  },
                  "grouped_ref": {
                    "type": "reference",
                    "desc": "References to the rules are been grouped."
                  }
                },
                "index": {
                  "pk": {
                    "type": "primary",
                    "attrs": ["grouping_ref", "grouped_ref"]
                  }
                },
                "relation": {
                  "groupingRule": {
                    "path": "/bon/calc/rank/rule/group",
                    "own": ["grouping_ref"],
                    "foreign": ["ref"],
                    "on": {"delete": "cascade", "update": "cascade"}
                  },
                  "groupedRule": {
                    "path": "/bon/calc/rank/rule",
                    "own": ["grouped_ref"],
                    "foreign": ["id"],
                    "on": {"delete": "cascade", "update": "cascade"}
                  }
                }
              }
            }
          },
          "pv": {
            ".": {
              "desc": "PV rules details.",
              "attr": {
                "ref": {
                  "type": "reference",
                  "desc": "Reference to the PV rule (type: pv)."
                },
                "volume": {
                  "type": "decimal",
                  "desc": "Minimal qualification volume.",
                  "precision": 10,
                  "scale": 2
                },
                "autoship_only": {
                  "type": "boolean",
                  "default": false,
                  "desc": "'true' if Autoship PV only is applied to qualification."
                },
                "period": {
                  "type": "integer",
                  "desc": "0 - PV from current period is applied; 1 - one period ago PV is applied; 2 - two periods ago ...",
                  "default": 0,
                  "small": true,
                  "unsigned": true
                }
              },
              "index": {
                "pk": {
                  "type": "primary",
                  "attrs": ["ref"]
                }
              },
              "relation": {
                "rule": {
                  "path": "/bon/calc/rank/rule",
                  "own": ["ref"],
                  "foreign": ["id"],
                  "on": {"delete": "cascade", "update": "cascade"}
                }
              }
            }
          },
          "rank": {
            ".": {
              "desc": "Rank rules details.",
              "attr": {
                "ref": {
                  "type": "reference",
                  "desc": "Reference to the rank rule (type: rank)."
                },
                "rank_ref": {
                  "type": "reference",
                  "desc": "Reference to the required rank."
                },
                "count": {
                  "type": "integer",
                  "small": true,
                  "desc": "Minimal count of the distributors with required rank."
                },
                "period": {
                  "type": "integer",
                  "desc": "0 - PV from current period is applied; 1 - one period ago PV is applied; 2 - two periods ago ...",
                  "default": 0,
                  "small": true,
                  "unsigned": true
                }
              },
              "index": {
                "pk": {
                  "type": "primary",
                  "attrs": ["ref"]
                }
              },
              "relation": {
                "rule": {
                  "path": "/bon/calc/rank/rule",
                  "own": ["ref"],
                  "foreign": ["id"],
                  "on": {"delete": "cascade", "update": "cascade"}
                },
                "rank": {
                  "path": "/bon/plan/rank",
                  "own": ["rank_ref"],
                  "foreign": ["id"],
                  "on": {"delete": "cascade", "update": "cascade"}
                }
              }
            }
          }
        }
      }
    },
    "cv": {
      ".note": "CV accounting (probably this namespace equals to 'dwnl'? should we move it one level up?).",
      "reg": {
        ".": {
          "desc": "Registry to save (Autoship) Commissionable Volumes (CV/ACV) movements.",
          "attr": {
            "id": {
              "type": "identity",
              "desc": "Registry entry ID."
            },
            "client_ref": {
              "type": "reference",
              "desc": "Reference to the client."
            },
            "volume": {
              "type": "decimal",
              "desc": "Amount of the CV/ACV to be add/subtract to/from client.",
              "precision": 10,
              "scale": 2
            },
            "is_autoship": {
              "type": "boolean",
              "default": false,
              "desc": "'true' if this is an Autoship CV."
            },
            "date": {
              "type": "datetime",
              "desc": "Timestamp to apply CV movement for client (used in bonus calculations)."
            },
            "type": {
              "type": "string",
              "desc": "Type of the movement to link this record with source by ID (sale, clawback).",
              "nullable": false
            }
          },
          "relation": {
            "client": {
              "path": "/dwnl/reg",
              "own": ["client_ref"],
              "foreign": ["client_ref"],
              "on": {"delete": "cascade", "update": "cascade"}
            }
          }
        },
        "sale": {
          ".": {
            "desc": "Links between entries in CV registry and related sales orders.",
            "attr": {
              "registry_ref": {
                "type": "reference",
                "desc": "Reference to the registry record."
              },
              "source_ref": {
                "type": "reference",
                "desc": "Reference to the sale order."
              }
            },
            "index": {
              "pk": {
                "type": "primary",
                "attrs": ["registry_ref"]
              },
              "unique": {
                "type": "unique",
                "attrs": ["source_ref"]
              }
            },
            "relation": {
              "registry": {
                "path": "/bon/cv/reg",
                "own": ["registry_ref"],
                "foreign": ["id"],
                "on": {"delete": "cascade", "update": "cascade"}
              },
              "sale": {
                "path": "/sale/order",
                "own": ["source_ref"],
                "foreign": ["id"],
                "on": {"delete": "cascade", "update": "cascade"}
              }
            }
          },
          "back": {
            ".": {
              "desc": "Links between records in CV registry and related sales orders clawbacks.",
              "attr": {
                "registry_ref": {
                  "type": "reference",
                  "desc": "Reference to the registry record."
                },
                "source_ref": {
                  "type": "reference",
                  "desc": "Reference to the sale order."
                }
              },
              "index": {
                "pk": {
                  "type": "primary",
                  "attrs": ["registry_ref"]
                },
                "unique": {
                  "type": "unique",
                  "attrs": ["source_ref"]
                }
              },
              "relation": {
                "registry": {
                  "path": "/bon/cv/reg",
                  "own": ["registry_ref"],
                  "foreign": ["id"],
                  "on": {"delete": "cascade", "update": "cascade"}
                },
                "sale": {
                  "path": "/bon/cv/reg/sale",
                  "own": ["source_ref"],
                  "foreign": ["source_ref"],
                  "on": {"delete": "cascade", "update": "cascade"}
                }
              }
            }
          }
        }
      }
    },
    "pool": {
      ".note": "Results for concrete calculations.",
      ".": {
        "desc": "Instances of the one set of calculations from one suite inside one period (cancelled, forecast, complete, etc).",
        "attr": {
          "id": {
            "type": "identity",
            "desc": "Calculations pool ID."
          },
          "period_ref": {
            "type": "reference",
            "desc": "Related period (bound to bonus suite)."
          },
          "date_started": {
            "type": "datetime",
            "desc": "Date when plan was created."
          }
        },
        "relation": {
          "result": {
            "path": "/bon/pool/period",
            "own": ["period_ref"],
            "foreign": ["id"],
            "on": {"delete": "cascade", "update": "cascade"}
          }
        }
      },
      "calc": {
        ".": {
          "desc": "Instance of the calculation inside of pool.",
          "attr": {
            "id": {
              "type": "identity",
              "desc": "Calculation ID."
            },
            "pool_ref": {
              "type": "reference",
              "desc": "Related pool (bound to period)."
            },
            "calc_ref": {
              "type": "reference",
              "desc": "Related bonus calculation."
            }
          },
          "index": {
            "unique": {
              "type": "unique",
              "attrs": ["pool_ref", "calc_ref"]
            }
          },
          "relation": {
            "pool": {
              "path": "/bon/pool",
              "own": ["pool_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            },
            "calc": {
              "path": "/bon/plan/suite/calc",
              "own": ["calc_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            }
          }
        }
      },
      "comm": {
        "level": {
          ".": {
            "desc": "Level based bonus commission values for pool calculation.",
            "attr": {
              "pool_calc_ref": {
                "type": "reference",
                "desc": "Reference to the calculation instance."
              },
              "client_ref": {
                "type": "reference",
                "desc": "Reference to the client."
              },
              "level": {
                "type": "integer",
                "unsigned": true,
                "small": true,
                "desc": "Appropriate level in the configuration."
              },
              "cv": {
                "type": "decimal",
                "desc": "Total volume of commission points.",
                "precision": 10,
                "scale": 2
              },
              "percent": {
                "type": "decimal",
                "desc": "Commission percent from the level for the client.",
                "precision": 5,
                "scale": 4
              },
              "commission": {
                "type": "decimal",
                "desc": "Commission amount from CV for the level.",
                "precision": 10,
                "scale": 2
              }
            },
            "index": {
              "pk": {
                "type": "primary",
                "attrs": ["pool_calc_ref", "client_ref", "level"]
              }
            },
            "relation": {
              "poolCalc": {
                "path": "/bon/pool/calc",
                "own": ["pool_calc_ref"],
                "foreign": ["id"],
                "on": {"delete": "cascade", "update": "cascade"}
              },
              "client": {
                "path": "/dwnl/reg",
                "own": ["client_ref"],
                "foreign": ["client_ref"],
                "on": {"delete": "cascade", "update": "cascade"}
              }
            }
          }
        }
      },
      "cv": {
        ".": {
          "desc": "CV/ACV are collected for period in one pool.",
          "attr": {
            "pool_calc_ref": {
              "type": "reference",
              "desc": "Reference to the calculation instance."
            },
            "client_ref": {
              "type": "reference",
              "desc": "Reference to the client."
            },
            "is_autoship": {
              "type": "boolean",
              "default": false,
              "desc": "'true' if this is an Autoship CV."
            },
            "volume": {
              "type": "decimal",
              "desc": "Amount of the CV/ACV to be add/subtract to/from client.",
              "precision": 10,
              "scale": 2
            }
          },
          "index": {
            "pk": {
              "type": "primary",
              "attrs": ["pool_calc_ref", "client_ref", "is_autoship"]
            }
          },
          "relation": {
            "poolCalc": {
              "path": "/bon/pool/calc",
              "own": ["pool_calc_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            },
            "client": {
              "path": "/dwnl/reg",
              "own": ["client_ref"],
              "foreign": ["client_ref"],
              "on": {"delete": "cascade", "update": "cascade"}
            }
          }
        }
      },
      "period": {
        ".": {
          "desc": "Registry for instances of bonus suites calculations (bound to period data and state).",
          "attr": {
            "id": {
              "type": "identity",
              "desc": "Period ID."
            },
            "suite_ref": {
              "type": "reference",
              "desc": "Related bonus suite."
            },
            "date_begin": {
              "type": "date",
              "desc": "Begin date of the period."
            },
            "state": {
              "type": "string",
              "desc": "Period state: open, closed"
            }
          },
          "index": {
            "unique": {
              "type": "unique",
              "attrs": ["suite_ref", "date_begin"]
            }
          },
          "relation": {
            "suite": {
              "path": "/bon/plan/suite",
              "own": ["suite_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            }
          }
        }
      },
      "rank": {
        ".": {
          "desc": "Qualifications on rank for pool calculation.",
          "attr": {
            "pool_calc_ref": {
              "type": "reference",
              "desc": "Reference to the calculation inside period."
            },
            "client_ref": {
              "type": "reference",
              "desc": "Reference to the client itself."
            },
            "rank_ref": {
              "type": "reference",
              "desc": "Reference to the qualification rank."
            }
          },
          "index": {
            "pk": {
              "type": "primary",
              "attrs": ["pool_calc_ref", "client_ref"]
            }
          },
          "relation": {
            "poolCalc": {
              "path": "/bon/pool/calc",
              "own": ["pool_calc_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            },
            "client": {
              "path": "/dwnl/reg",
              "own": ["client_ref"],
              "foreign": ["client_ref"],
              "on": {"delete": "cascade", "update": "cascade"}
            },
            "rank": {
              "path": "/bon/plan/rank",
              "own": ["rank_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            }
          }
        }
      },
      "tree": {
        ".": {
          "desc": "Downline tree data bound to bonus calculations.",
          "attr": {
            "pool_calc_ref": {
              "type": "reference",
              "desc": "Reference to the calculation inside period (plain & compressed, for example)."
            },
            "client_ref": {
              "type": "reference",
              "desc": "Reference to the client itself."
            },
            "parent_ref": {
              "type": "reference",
              "desc": "Reference to the client's parent.",
              "nullable": false
            },
            "pv": {
              "type": "decimal",
              "desc": "Personal Volume (autoship is included).",
              "precision": 10,
              "scale": 2
            },
            "apv": {
              "type": "decimal",
              "desc": "Personal Volume (autoship only).",
              "precision": 10,
              "scale": 2
            }
          },
          "index": {
            "pk": {
              "type": "primary",
              "attrs": ["pool_calc_ref", "client_ref"]
            }
          },
          "relation": {
            "poolCalc": {
              "path": "/bon/pool/calc",
              "own": ["pool_calc_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            },
            "client": {
              "path": "/dwnl/reg",
              "own": ["client_ref"],
              "foreign": ["client_ref"],
              "on": {"delete": "cascade", "update": "cascade"}
            },
            "parent": {
              "path": "/dwnl/reg",
              "own": ["parent_ref"],
              "foreign": ["client_ref"],
              "on": {"delete": "cascade", "update": "cascade"}
            }
          }
        }
      }
    },
    "plan": {
      ".note": "Bonus plan construction data.",
      ".": {
        "desc": "Set of bonus suites related to one set of ranks.",
        "attr": {
          "id": {
            "type": "identity",
            "desc": "Plan ID."
          },
          "date_created": {
            "type": "date",
            "desc": "Date when plan was created."
          },
          "note": {
            "type": "string",
            "desc": "Plan description for humans."
          }
        }
      },
      "calc": {
        "type": {
          ".": {
            "desc": "Calculations types codifier.",
            "attr": {
              "id": {
                "type": "identity",
                "desc": "Calculation type ID."
              },
              "code": {
                "type": "string",
                "desc": "Calculation code to be referenced from programs/scripts."
              },
              "note": {
                "type": "string",
                "desc": "Calculation type reference for humans."
              }
            },
            "index": {
              "unique": {
                "type": "unique",
                "attrs": ["code"]
              }
            }
          },
          "deps": {
            "after": {
              ".": {
                "desc": "Calculations are based on other calculations (ref depends on other_ref).",
                "attr": {
                  "ref": {
                    "type": "reference",
                    "desc": "Main calculation."
                  },
                  "other_ref": {
                    "type": "reference",
                    "desc": "Base calculation for main calculation."
                  }
                },
                "index": {
                  "pk": {
                    "type": "primary",
                    "attrs": ["ref", "other_ref"]
                  }
                },
                "relation": {
                  "ref": {
                    "path": "/bon/plan/calc/type",
                    "own": ["ref"],
                    "foreign": ["id"],
                    "on": {"delete": "cascade", "update": "cascade"}
                  },
                  "otherRef": {
                    "path": "/bon/plan/calc/type",
                    "own": ["other_ref"],
                    "foreign": ["id"],
                    "on": {"delete": "cascade", "update": "cascade"}
                  }
                }
              }
            },
            "before": {
              ".": {
                "desc": "Calculations that should be performed before other calculations.",
                "attr": {
                  "ref": {
                    "type": "reference",
                    "desc": "Main calculation."
                  },
                  "other_ref": {
                    "type": "reference",
                    "desc": "Main calculation should be performed before this calc."
                  }
                },
                "index": {
                  "pk": {
                    "type": "primary",
                    "attrs": ["ref", "other_ref"]
                  }
                },
                "relation": {
                  "ref": {
                    "path": "/bon/plan/calc/type",
                    "own": ["ref"],
                    "foreign": ["id"],
                    "on": {"delete": "cascade", "update": "cascade"}
                  },
                  "otherRef": {
                    "path": "/bon/plan/calc/type",
                    "own": ["other_ref"],
                    "foreign": ["id"],
                    "on": {"delete": "cascade", "update": "cascade"}
                  }
                }
              }
            }
          }
        }
      },
      "rank": {
        ".": {
          "desc": "Ranks bound to the concrete plan.",
          "attr": {
            "id": {
              "type": "identity",
              "desc": "Rank ID."
            },
            "plan_ref": {
              "type": "reference",
              "desc": "Reference to the plan."
            },
            "code": {
              "type": "string",
              "desc": "Small code for the rank."
            },
            "note": {
              "type": "string",
              "desc": "Description of the rank for humans."
            },
            "sequence": {
              "type": "integer",
              "desc": "Calculation sequence (order) in the plan.",
              "small": true,
              "unsigned": true
            }
          },
          "relation": {
            "plan": {
              "path": "/bon/plan",
              "own": ["plan_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            }
          }
        }
      },
      "suite": {
        ".": {
          "desc": "Set of calculations related to one period type (day, week, month, year).",
          "attr": {
            "id": {
              "type": "identity",
              "desc": "Plan ID."
            },
            "plan_ref": {
              "type": "reference",
              "desc": "Reference to the bonus plan."
            },
            "period": {
              "type": "string",
              "desc": "Period type (D)AY, (W)EEK, (M)ONTH, (Y)EAR)."
            },
            "date_created": {
              "type": "date",
              "desc": "Date when plan was created."
            },
            "note": {
              "type": "string",
              "desc": "Plan description for humans."
            }
          },
          "relation": {
            "suite": {
              "path": "/bon/plan",
              "own": ["plan_ref"],
              "foreign": ["id"],
              "on": {"delete": "cascade", "update": "cascade"}
            }
          }
        },
        "calc": {
          ".": {
            "desc": "Calculations being bound to the concrete suite.",
            "attr": {
              "id": {
                "type": "identity",
                "desc": "Calculation ID."
              },
              "suite_ref": {
                "type": "reference",
                "desc": "Reference to the plan."
              },
              "type_ref": {
                "type": "reference",
                "desc": "Reference to the calculation type."
              },
              "sequence": {
                "type": "integer",
                "desc": "Calculation sequence (order) in the plan.",
                "small": true,
                "unsigned": true
              },
              "date_created": {
                "type": "datetime",
                "desc": "Date when first calculation was (will be) performed.",
                "small": true,
                "unsigned": true
              }
            },
            "relation": {
              "suite": {
                "path": "/bon/plan/suite",
                "own": ["suite_ref"],
                "foreign": ["id"],
                "on": {"delete": "cascade", "update": "cascade"}
              },
              "calcType": {
                "path": "/bon/plan/calc/type",
                "own": ["type_ref"],
                "foreign": ["id"],
                "on": {"delete": "cascade", "update": "cascade"}
              }
            }
          }
        }
      }
    }
  }
}